## Практическая работа 13

### Диаграмма


>![Результат 1](/d1.png)

### Описание компонентов и стратегии отказоустойчивости:

**Клиенты**:  Конечные пользователи магазина.

**Cloudflare** (DNS, CDN, WAF):

- DNS:  Глобальное распределение DNS записей для быстрого разрешения доменного имени.
- CDN:  Кэширование статического контента (изображения, CSS, JavaScript) для снижения нагрузки на серверы и ускорения загрузки страниц для пользователей.
- WAF (Web Application Firewall):  Защита от атак (SQL injection, XSS и т.д.) на уровне приложения.

**ЦОД 1, ЦОД 2, ЦОД 3:** Три географически распределенных центра обработки данных.

- Kubernetes Cluster:  В каждом ЦОД развернут кластер Kubernetes для оркестрации Docker-контейнеров.
- Ingress Controller:  Маршрутизирует входящий трафик к нужным сервисам внутри кластера.  Используется, например, Nginx Ingress Controller или Traefik.
- API Gateway:  Обеспечивает единую точку входа для всех сервисов, выполняет аутентификацию, авторизацию, лимитирование трафика и другие функции.
- Сервисы (Каталог, Заказы, Клиенты, Логистика, Производство, Склады):  Разделены на микросервисы, каждый из которых выполняет свою функцию. В каждом ЦОД развернуты реплики каждого сервиса.

**Кластер Базы Данных (PostgreSQL, Multi-AZ):**

- Primary DB Node:  Основной узел базы данных, принимающий записи.
- Secondary DB Node 1, Secondary DB Node 2:  Реплики базы данных, которые автоматически переключаются на себя в случае отказа Primary DB Node.  Используется, например, PostgreSQL с Streaming Replication или Patroni.
- Object Storage (S3-compatible):  Хранение статических файлов, резервных копий баз данных и других данных.
- Message Queue (Kafka, Multi-AZ):  Используется для асинхронного обмена сообщениями между сервисами.  Обеспечивает надежную доставку сообщений даже в случае отказа одного из сервисов.
- Система аналитики: Собирает данные из очереди сообщений для предоставления аналитических отчетов.

#### Стратегия отказоустойчивости:

- Гео-распределение:  Размещение инфраструктуры в трех ЦОД обеспечивает отказоустойчивость на уровне ЦОД.  В случае отказа одного ЦОД, трафик автоматически перенаправляется на оставшиеся два.
- Kubernetes:  Автоматическое масштабирование, самовосстановление и управление контейнерами.  В случае отказа одного из контейнеров, Kubernetes автоматически перезапустит его.
- Multi-AZ база данных:  Автоматическое переключение на резервный узел базы данных в случае отказа основного узла.
- Репликация сервисов:  Развертывание нескольких реплик каждого сервиса в каждом ЦОД обеспечивает балансировку нагрузки и отказоустойчивость.
- Асинхронная обработка сообщений:  Использование Message Queue гарантирует, что данные не будут потеряны в случае отказа одного из сервисов.
- CDN:  Кэширование контента снижает нагрузку на серверы и обеспечивает быструю загрузку страниц для пользователей даже в случае проблем с одним из ЦОД.


**Приоритеты восстановления:**

- Сервис Заказов:  Критически важен для получения прибыли.  Восстанавливается в первую очередь.
- Сервис Каталога:  Важен для просмотра товаров.  Восстанавливается во вторую очередь.
- Сервис Клиентов:  Важен для авторизации и управления профилями пользователей.  Восстанавливается в третью очередь.
- Сервис Складов и Логистики:  Важны для выполнения заказов.  Восстанавливаются в четвертую очередь.
- Сервис Производства:  Наименее критичен для работы магазина.  Восстанавливается в последнюю очередь.

#### Стратегии выката новых версий

**Тестирование новой технологии (Canary Deployment):**

- Развертывание новой версии сервиса (с новой технологией) на небольшом подмножестве серверов (например, 5%).
- Маршрутизация небольшого процента пользовательского трафика на новую версию сервиса.
- Мониторинг производительности и ошибок новой версии сервиса.
- Если все хорошо, постепенное увеличение трафика на новую версию сервиса до 100%.
- Если обнаружены проблемы, немедленное переключение трафика обратно на старую версию сервиса и откат изменений.

**Минорное изменение без времени простоя (Rolling Update):**

- Kubernetes автоматически заменяет старые реплики сервиса на новые, по одной реплике за раз.
- Во время обновления сервиса доступен, так как старые реплики продолжают обслуживать трафик до тех пор, пока новые реплики не станут готовы.

**Мажорное обновление без сохранения обратной совместимости работы с базой данных (Blue-Green Deployment):**

- Создание нового окружения (Green) с новой версией сервиса и новой схемой базы данных.
- Копирование данных из старой базы данных (Blue) в новую базу данных (Green).
- Переключение трафика с Blue окружения на Green окружение.
- После успешного переключения, Blue окружение можно удалить.

#### Стенды для тестирования:

- Dev-стенд:  Для разработки и тестирования кода разработчиками.
- Test-стенд:  Для автоматизированного тестирования (unit-тесты, интеграционные тесты, E2E-тесты).  Должен быть максимально приближен к prod-стенду.
- Staging-стенд:  Для ручного тестирования и проверки интеграции всех компонентов системы.  Полная копия prod-стенда.
- Performance-стенд:  Для нагрузочного тестирования и определения узких мест в системе.

#### Переключение между ЦОД

- Автоматическое переключение с помощью DNS и Ingress Controller:  Cloudflare DNS настроен с health checks для каждого ЦОД.  В случае отказа одного ЦОД, Cloudflare автоматически удаляет этот ЦОД из DNS записей, и трафик перенаправляется на оставшиеся ЦОД.  Ingress Controller в каждом ЦОД также выполняет health checks для сервисов и автоматически перенаправляет трафик на доступные реплики.
- Оркестратор (Kubernetes) управляет размещением сервисов:  Kubernetes распределяет сервисы между ЦОД с учетом доступных ресурсов и правил affinity/anti-affinity.  В случае отказа одного ЦОД, Kubernetes автоматически перераспределяет сервисы на оставшиеся ЦОД.

#### DRP (Disaster Recovery Plan)

- Описание сценариев отказа:  Отказ ЦОД, отказ сети, отказ базы данных, отказ сервиса.
- Оценка влияния на бизнес:  Потеря прибыли, репутационные риски, штрафы.
- Процедуры восстановления:  Пошаговые инструкции по восстановлению системы в случае отказа.
- RTO (Recovery Time Objective):  Целевое время восстановления системы.
- RPO (Recovery Point Objective):  Максимально допустимая потеря данных.

#### Резервное копирование базы данных

- Ежедневное полное резервное копирование (full backup):  Сохранение полной копии базы данных в Object Storage.
- Инкрементальное резервное копирование (incremental backup):  Сохранение изменений, внесенных в базу данных с момента последнего полного или инкрементального резервного копирования.
- Хранение резервных копий в течение определенного периода времени (например, 30 дней).
- Регулярная проверка восстановления из резервных копий.
1. Оценка потерь данных:
2. Потеря данных о заказах:  Потеря прибыли, недовольство клиентов.
3. Потеря данных о клиентах:  Потеря лояльности клиентов, нарушение GDPR.
4. Потеря данных о товарах:  Невозможность продавать товары.