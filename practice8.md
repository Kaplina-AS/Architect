## Практическая работа 8

### Сервисная модель

1. Сервис заказов 

**Обоснование:** Цикл заказа (создание, изменение статуса, оплата, отгрузка, доставка, отмена) является ключевым процессом бизнеса компании: запасы, логистика, финансы, клиентский опыт. Точное и детальное отслеживание каждого этапа позволяет оптимизировать эти процессы, выявлять узкие места и улучшать качество обслуживания. Исторические данные о заказах необходимы для прогнозирования спроса, анализа продаж и маркетинговых кампаний.

**Плюсы**:

- Возможность быстрого построения отчетов по количеству заказов по статусам, времени выполнения каждого этапа, причинам отмен и т.д.
- Анализ трендов, корреляций и аномалий в поведении заказов.
- Возможность построения аналитических витрин данных.
- Реагирование в реальном времени: отправка уведомлений клиентам об изменении статуса заказа, запуск процессов автоматизации склада при поступлении новых заказов.

**Риски**:

- Повышение сложности системы: Внедрение брокера сообщений, обеспечение надежности доставки сообщений, обработка ошибок.
- Возможные задержки в консистентности данных.  За сче асинхронной обработки, данные в разных системах могут быть не синхронизированы в каждый момент времени.
- Отслеживание потока событий между сервисами может быть сложной задачей.

2. Сервис Склад

**Обоснование:** Отслеживание изменений складских запасов (поступление, отгрузка, резервирование, списание) необходимо для оптимизации управления запасами, предотвращения дефицита и излишков, а также для расчета себестоимости продукции.

**Плюсы**:

- Уточненый учет запасов:  Отслеживание движения каждого товара в режиме реального времени.
- Автоматизация пополнения запасов:  Автоматическое создание заявок на закупку при достижении критического уровня запасов.
- Предотвращение "over-selling":  Точное знание о доступном количестве товаров позволяет избежать ситуаций, когда заказы принимаются на товары, которых нет в наличии.

**Риски**: аналог для сервиса заказов. Но могут стать менее критичными

3. Сервис Платежи. Менее критичен для перевода на событийную модель, но может быть полезен.


**Обоснование**: Отслеживание статусов платежей (успешный, отклоненный, возвращенный) важно для финансовой отчетности, борьбы с мошенничеством и улучшения клиентского опыта.

**Плюсы**:

- Автоматизация возвратов: Автоматический запуск процессов возврата денег при отмене заказа.
- Обнаружение мошеннических транзакций:  Анализ паттернов платежей для выявления подозрительной активности.

**Риски**:  Чувствительность к безопасности данных, необходимость соответствия PCI DSS

### Агрегаты, события и команды

1. Сервис Заказы

**Агрегат**: Заказ (Order)

**Назначение**: Управление информацией о заказе (статус, товары, клиент, оплата)

**Команды**:

- CreateOrder (Создать заказ)
- UpdateOrderStatus (Обновить статус заказа)
- CancelOrder (Отменить заказ)

**События**:

- OrderCreated (Заказ создан)
- OrderStatusUpdated (Статус заказа обновлен)
- OrderCancelled (Заказ отменен)
- OrderCompleted (Заказ завершен)

**Агрегат**: Позиция товара (OrderItem) 

**Назначение**: Управление позициями в заказе (товар, количество, цена).

**Команды**: создаются/удаляются вместе с Order, поэтому отдельных команд не предусмотрим

**События**: генерируются вместе с событиями Order, поэтому отдельных событий не предусмотрим

2. Сервис Склад

**Агрегат**: InventoryItem

**Назначение**: Управление информацией о складском запасе для конкретного товара.

**Команды**:

- ReserveInventory (Зарезервировать товар)
- DeductInventory (Списать товар)
- RestockInventory (Пополнить запас товара)
- UnreserveInventory (Отменить резервирование товара)

**События**:

- InventoryReserved (Товар зарезервирован)
- InventoryDeducted (Товар списан)
- InventoryRestocked (Запас товара пополнен)
- InventoryUnreserved (Резервирование товара отменено)

3. Payment Service

**Агрегат**: Payment

**Назначение**: Управление информацией о платеже.

**Команды**:

- ChargePayment (Провести платеж)
- RefundPayment (Вернуть платеж)

**События**:

- PaymentCharged (Платеж проведен)
- PaymentRefunded (Платеж возвращен)
- PaymentFailed (Платеж не удался)

>![Результат 1](/diag_sost.png)

### Цепочка событий

Создание заказа -> Резервирование товара -> Проведение платежа -> Списание товара -> Завершение заказа


1. Команда **CreateOrder** :

order_id:  UUID (уникальный идентификатор заказа)

user_id: UUID (идентификатор пользователя)

order_date:  Timestamp (дата и время создания заказа)

total_amount: Decimal (общая сумма заказа)

shipping_address:  Object (адрес доставки: улица, город, индекс и т.д.)

billing_address: Object (платежный адрес)

payment_method:  Enum (способ оплаты: credit_card, paypal, и т.д.)

order_items:  Array (массив объектов OrderItem)

product_id: UUID (идентификатор товара)

quantity: Integer (количество)

price: Decimal (цена за единицу)

**Обоснование**:  Содержит всю необходимую информацию для создания заказа. Адреса передаются как объекты, а не просто как ID, чтобы обеспечить независимость от User Service (можно добавить информацию об адресе прямо в заказ, если User Service недоступен). order_items передаются в виде массива, чтобы можно было заказать несколько товаров.

2. Событие **OrderCreated** :

order_id: UUID (идентификатор заказа)

user_id: UUID (идентификатор пользователя)

order_date: Timestamp (дата и время создания заказа)

total_amount: Decimal (общая сумма заказа)

shipping_address:  Object (адрес доставки)

billing_address: Object (платежный адрес)

payment_method:  Enum (способ оплаты)

order_items:  Array (массив объектов OrderItem)

product_id: UUID (идентификатор товара)

quantity: Integer (количество)

price: Decimal (цена за единицу)

**Обоснование**:  Дублирует данные из CreateOrder, чтобы другие сервисы могли получить необходимую информацию без обращения к Order Service.  Это позволяет снизить зависимость между сервисами.

3. Команда **ReserveInventory**:

order_id: UUID (идентификатор заказа)

order_items:  Array (массив объектов OrderItem)

product_id: UUID (идентификатор товара)

quantity: Integer (количество для резервирования)

**Обоснование**:  Указывает, какие товары и в каком количестве нужно зарезервировать для конкретного заказа.

4. Событие **InventoryReserved**:

order_id: UUID (идентификатор заказа)

order_items:  Array (массив объектов OrderItem)

product_id: UUID (идентификатор товара)

quantity: Integer (количество зарезервированное)

**Обоснование**: Подтверждает, что товары зарезервированы. Может содержать информацию о фактически зарезервированном количестве (если не все товары удалось зарезервировать).

5. Команда **ChargePayment** :

order_id: UUID (идентификатор заказа)

user_id: UUID (идентификатор пользователя)

amount: Decimal (сумма к оплате)

payment_method: Enum (способ оплаты)

payment_details: Object (детали платежа, зависящие от способа оплаты, например, номер кредитной карты, срок действия и т.д.).

**Обоснование**: Содержит всю необходимую информацию для проведения платежа.  user_id может использоваться для проверки лимитов или истории платежей.

6. Событие **PaymentCharged**:

order_id: UUID (идентификатор заказа)

user_id: UUID (идентификатор пользователя)

amount: Decimal (сумма к оплате)

transaction_id: UUID (идентификатор транзакции)

payment_method: Enum (способ оплаты)

status: Enum (статус платежа: approved, declined)

**Обоснование**:  Подтверждает, что платеж был успешно проведен и содержит идентификатор транзакции для отслеживания.

7. Команда **DeductInventory**:

order_id: UUID (идентификатор заказа)

order_items:  Array (массив объектов OrderItem)

product_id: UUID (идентификатор товара)

quantity: Integer (количество для списания)

**Обоснование**: Указывает, какие товары и в каком количестве нужно списать со склада.

8. Событие **InventoryDeducted** :

order_id: UUID (идентификатор заказа)

order_items:  Array (массив объектов OrderItem)

product_id: UUID (идентификатор товара)

quantity: Integer (количество списанное)

**Обоснование**:  Подтверждает, что товары были списаны со склада.

9. Команда **UpdateOrderStatus**:

order_id: UUID (идентификатор заказа)

new_status: Enum (новый статус заказа: completed)

**Обоснование**:  Обновляет статус заказа, указывая, что он завершен.

10. Событие **OrderCompleted**:

order_id: UUID (идентификатор заказа)

status: Enum (статус заказа: completed)

**Обоснование**:  Подтверждает, что заказ был завершен.

>![Результат 2](/sq.png)